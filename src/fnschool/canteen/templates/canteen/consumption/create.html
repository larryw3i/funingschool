{% extends "base/header_content_footer.html" %}
{% load crispy_forms_tags %}
{% block title %}
  {% trans "Consume Ingredients" %}
{% endblock %}
{% block content %}
  <h1>{% trans "Consume Ingredients" %}</h1>
  <hr>
  <div class="container">
    <div class="row justify-content-end">
      <div class="col col-3 col-md-2 col-lg-2">
        <input class="  form-control"
               id="storage_date_start"
               value="{{ request.GET.date_start }}">
      </input>
    </div>
    <div class="col col-3 col-md-2 col-lg-2">
      <input class="form-control "
             id="storage_date_end"
             value="{{ request.GET.date_end }}">
    </input>
  </div>
  <button class="btn btn-success col-md-1 col-lg-1 col-2"
          onclick="list_consumptions();">{% trans "Refresh" %}</button>
</div>
</div>
<div class="table table-responsive table-container">
  <table class="table table-consumptions cotable-bordered table-striped table-hover table-condensed scroll-vertical ">
    <thead>
      <tr>
        {% if ingredients %}
          <th class="">{% trans "Ingredient Name" %}</th>
          <th class="">{% trans "Remaining Quantity" %}</th>
        {% endif %}
        {% for date_h in date_range %}
          <th class="consumption-date">{{ date_h }}</th>
        {% empty %}
          <th></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for ingredient in ingredients %}
        <tr class="row-consumption"
            data-ingredient_name="{{ ingredient.name }}"
            data-ingredient_quantity="{{ ingredient.quantity }}"
            data-ingredient_total_price="{{ ingredient.total_price }}"
            data-ingredient_meal_type="{{ ingredient.meal_type }}"
            data-ingredient_quantity_unit_name="{{ ingredient.quantity_unit_name }}"
            data-ingredient_unit_price="{{ ingredient.unit_price }}"
            id="ingredient_num_{{ ingredient.id }}">
          <td title="{% blocktrans with storage_date=ingredient.storage_date %}Storaged on {{ storage_date }} .{% endblocktrans %}"
              class="">
            {{ ingredient.name }}
            {% if ingredient.meal_type %}
              <br />
              ({{ ingredient.meal_type }})
            {% endif %}
          </td>
          <td name="remaining_{{ ingredient.id }}">
            {{ ingredient.quantity }}-{{ ingredient.consuming_quantity }}={{ ingredient.remaining_quantity }}
          </td>
        </tr>
      {% empty %}
        <tr>{% trans "No ingredient found." %}</tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="">
  <button onclick="submit_consumptions();"
          class="btn btn-submit-consumptions btn-primary float-start">
    {% trans "Submit" %}
  </button>
  <button onclick="generate_spreadsheet();"
          class="btn btn-submit-consumptions btn-success float-end">
    {% trans "Generate Spreadsheet" %}
  </button>
  <select class="workbook-month-select form-select float-end mx-2"
          style="width:118px"></select>
</div>
<script>
    function get_previous_month_date(date = new Date()) {
  const prevMonthDate = new Date(date);
  prevMonthDate.setDate(1);
  prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
  return prevMonthDate;
}

    function is_weekend(date) {
      const dayOfWeek = date.getDay(); 
      return dayOfWeek === 0 || dayOfWeek === 6; 
    }
    var ingredient_ids = [ 
      {% for ingredient in ingredients %}"{{ingredient.id}}",{% endfor %}
    ];

    $(document).ready(function(){
      var monthes = [...new Set(
        [
        {% for date_h in date_range %}'{{date_h}}',{% endfor %}
      ].map(item => item.slice(0,-3)))]

      $(monthes).each(function(index,value){ 
        $('.workbook-month-select').append(`<option>${value}</option>`)
      });
      var now = new Date();
      prev_month = get_previous_month_date(now)
      var year = prev_month.getFullYear();
      var month = prev_month.getMonth()+1 ;
      month = month< 10 ? `0${month}` : `${month}`;
      $('.workbook-month-select').val(`${year}-${month}`)

    });

    var ingredient_ids_length = ingredient_ids.length
    
    $(document).ready(function(){
      var last_meal_type=""
      var consumption_rows = $(".row-consumption")
      consumption_rows.each(function(index,element){
        meal_type = $(element).data("ingredient_meal_type")
        if (last_meal_type != meal_type){
          $(element).find("td").css({"color":"red"})
          last_meal_type = meal_type
        }
      });
    });

    $(document).ready(function(){
      var td1 = $(".table tr > :nth-child(1):first")
      $(".table tr > :nth-child(2)").css("left",td1.width())
    });

    $(document).ready(function(){
    $.each(ingredient_ids,function (index, value) {

              $.ajax(
                {
                  url:"/canteen/create_consumption/"+value,
                  method: 'GET',
                  success: function(data){
                    data=$(data)
                    data.each(function(index,element){
                        if (is_weekend(new Date($(element).data("date_of_using")))){
                          $(element).find('[name="amount_used"]').addClass("weekend")
                    }
                    });
                    data.find('input[name="amount_used"]').blur(function(){
                      amount_used = $(this).closest("form").data("amount_used")
                      new_amount_used = $.trim($(this).val())
                      if(parseFloat(amount_used) > 0.0 && new_amount_used === ""){
                        $(this).val('0.0')
                      }
                    });
                    $('#ingredient_num_'+value).append(data)

                  }
                }
              );
    });
    });


    $(document).ready(function() {
    $('.table-consumptions').on('keydown', 'input[name="amount_used"]', function(e) {
        if ([9,13,37,38,39,40].includes(e.keyCode)) {
            e.preventDefault();
            navigateToNextCell(
              $(this), 
              e.keyCode === 9 ? "r" :
              e.keyCode === 13 ? "d" : 
              e.keyCode === 37 ? "l" :
              e.keyCode ===  38 ? "u" :
              e.keyCode === 39 ? "r" :
              e.keyCode === 40 ? "d" : "" 
            );                
        }
      if ((e.keyCode < 91 && e.keyCode > 64) || e.keyCode == 32) {
                e.preventDefault()
                }

    });

   function navigateToNextCell($currentInput,direction ) {
      var td = $currentInput.closest("form").closest('td');
      var columnIndex = td.index();

     var rowIndex = td.closest("tr").index()
     if (direction == 'l'){
       columnIndex = columnIndex - 1
       rowIndex = rowIndex + 1
     }else if(direction == 'r'){
       columnIndex = columnIndex + 1
       rowIndex = rowIndex + 1
     }else if (direction == "u"){
       rowIndex = rowIndex 
     }else if (direction == 'd'){
       rowIndex = rowIndex + 2
     }
      var cell = $('.table-consumptions').find(`tr:eq(${rowIndex}) td:eq(${columnIndex})`);
     var amount_used_input=cell.find('input[name="amount_used"]')
     amount_used_input.first().focus()

   }
    });

    function generate_spreadsheet() {
      submit_consumptions(function (){
        var month = $(".month-select").val()
        window.open(`/canteen/generate_spreadsheet/${month}`, '_blank'); 
      });
       
    }
    function submit_consumptions(fn) {
      consumption_forms =  $('form[name="consumption_form"]')
      var requests = [];
      consumption_forms.each( function(index) {
          var form = $(this);
         if (form.data("is_disabled")=="True"){
           return true;
         }
         if (form.find('input[name="amount_used"]').val().length < 1){
           return true;
         }
        requests.push(
        $.ajax({
        url: form.attr('action'),
        type: form.attr('method') || 'POST', 
        data: form.serialize(),
    }).catch(function(error) {
      return erroe;}));
        });
      $.when.apply($, requests)
  .done(function() {
    if (! fn == undefined){
      fn()
    }
    location.reload();
  })
  .fail(function() {
  });
    }
    function set_consumptions_table_size(){
      const submit_consumptions_btn = $(".btn-submit-consumptions")
      const consumptions_table=$(".table-consumptions")
      const header=$("header")
      const footer=$("footer")
      const height = Math.round((footer.offset().top - submit_consumptions_btn.height() - consumptions_table.offset().top  )*0.95)
        consumptions_table.parent().height(height)
    }
    $(window).resize(function() {
      set_consumptions_table_size()
    });
    $(document).ready(function() {
      set_consumptions_table_size()
});
          
    function list_consumptions(){
       var date_start = $('#storage_date_start').val()
      var date_end =  $('#storage_date_end').val()
      query = {}
      if (date_start) {
          query["date_start"] = date_start
          set_simple_cookie("date_start",date_start)
      }
       if (date_end) {
         query["date_end"] = date_end
         set_simple_cookie("date_end",date_end)
      }
      if (date_start || date_end){
        update_href(query)
      }
    }
</script>
<style>
.weekend {
  background-color:pink;
}

.table-container {
  overflow:auto;
}
  .table thead th {
      position: -webkit-sticky; 
      position: sticky;
      top: 0; 
      z-index: 1010; 
  }

  .table tr {
      font-size:15px;
  }
 .table tr > :nth-child(1) {
      position: -webkit-sticky; 
      position: sticky;
      left: 0;
      z-index: 1010; 
      white-space: nowrap;
  }

  .table tr > :nth-child(2) {
      position: -webkit-sticky; 
      position: sticky;
      z-index: 1010; 
  }
  .table thead tr {
      font-size:15px;
  }
   .table thead tr > :nth-child(1) {
      z-index: 1020;
      white-space: nowrap;
  }
  .table thead tr > :nth-child(2) {
      z-index: 1020; 
  }

nav li {
  z-index: 1030;
}

</style>
{% endblock %}
