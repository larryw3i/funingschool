{% extends "base/header_content_footer.html" %}
{% load crispy_forms_tags %}
{% block title %}
  {% trans "Consume Ingredients" %}
{% endblock %}
{% block content %}
  <h1>{% trans "Consume Ingredients" %}</h1>
  <hr>
  <div class="container mt-4">
    <div class="row justify-content-end">
      <div class="col-md-6">
        <div class="d-flex flex-column align-items-end">
          <!-- Start Date Selector -->
          <div class="mb-3 w-100">
            <label for="date_start" class="form-label">Start Date</label>
            <div class="input-group date" id="date_start_group">
              <input type="text" class="form-control" id="date_start" name="date_start">
              <span class="input-group-text"><i class="bi bi-calendar"></i></span>
            </div>
          </div>
          <!-- End Date Selector -->
          <div class="w-100">
            <label for="date_end" class="form-label">End Date</label>
            <div class="input-group date" id="date_end_group">
              <input type="text" class="form-control" id="date_end" name="date_end">
              <span class="input-group-text"><i class="bi bi-calendar"></i></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="div_id_storage_date" class="mb-3">
    <fieldset>
      <legend for="id_storage_date_year" class="form-label requiredField">
        入库日期<span class="asteriskField">*</span>
      </legend>
      <select name="storage_date_year"
              required=""
              id="id_storage_date_year"
              style="width: 33.33%;
                     display: inline-block"
              class="selectdatewidget form-control">
        <option value="1925">1925</option>
        <option value="1926">1926</option>
        <option value="1927">1927</option>
        <option value="1928">1928</option>
        <option value="1929">1929</option>
        <option value="1930">1930</option>
        <option value="1931">1931</option>
        <option value="1932">1932</option>
        <option value="1933">1933</option>
        <option value="1934">1934</option>
        <option value="1935">1935</option>
        <option value="1936">1936</option>
        <option value="1937">1937</option>
        <option value="1938">1938</option>
        <option value="1939">1939</option>
        <option value="1940">1940</option>
        <option value="1941">1941</option>
        <option value="1942">1942</option>
        <option value="1943">1943</option>
        <option value="1944">1944</option>
        <option value="1945">1945</option>
        <option value="1946">1946</option>
        <option value="1947">1947</option>
        <option value="1948">1948</option>
        <option value="1949">1949</option>
        <option value="1950">1950</option>
        <option value="1951">1951</option>
        <option value="1952">1952</option>
        <option value="1953">1953</option>
        <option value="1954">1954</option>
        <option value="1955">1955</option>
        <option value="1956">1956</option>
        <option value="1957">1957</option>
        <option value="1958">1958</option>
        <option value="1959">1959</option>
        <option value="1960">1960</option>
        <option value="1961">1961</option>
        <option value="1962">1962</option>
        <option value="1963">1963</option>
        <option value="1964">1964</option>
        <option value="1965">1965</option>
        <option value="1966">1966</option>
        <option value="1967">1967</option>
        <option value="1968">1968</option>
        <option value="1969">1969</option>
        <option value="1970">1970</option>
        <option value="1971">1971</option>
        <option value="1972">1972</option>
        <option value="1973">1973</option>
        <option value="1974">1974</option>
        <option value="1975">1975</option>
        <option value="1976">1976</option>
        <option value="1977">1977</option>
        <option value="1978">1978</option>
        <option value="1979">1979</option>
        <option value="1980">1980</option>
        <option value="1981">1981</option>
        <option value="1982">1982</option>
        <option value="1983">1983</option>
        <option value="1984">1984</option>
        <option value="1985">1985</option>
        <option value="1986">1986</option>
        <option value="1987">1987</option>
        <option value="1988">1988</option>
        <option value="1989">1989</option>
        <option value="1990">1990</option>
        <option value="1991">1991</option>
        <option value="1992">1992</option>
        <option value="1993">1993</option>
        <option value="1994">1994</option>
        <option value="1995">1995</option>
        <option value="1996">1996</option>
        <option value="1997">1997</option>
        <option value="1998">1998</option>
        <option value="1999">1999</option>
        <option value="2000">2000</option>
        <option value="2001">2001</option>
        <option value="2002">2002</option>
        <option value="2003">2003</option>
        <option value="2004">2004</option>
        <option value="2005">2005</option>
        <option value="2006">2006</option>
        <option value="2007">2007</option>
        <option value="2008">2008</option>
        <option value="2009">2009</option>
        <option value="2010">2010</option>
        <option value="2011">2011</option>
        <option value="2012">2012</option>
        <option value="2013">2013</option>
        <option value="2014">2014</option>
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2017">2017</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected="">2025</option>
      </select>
      <select name="storage_date_month"
              required=""
              id="id_storage_date_month"
              style="width: 33.33%;
                     display: inline-block"
              class="selectdatewidget form-control">
        <option value="1">一月</option>
        <option value="2">二月</option>
        <option value="3">三月</option>
        <option value="4">四月</option>
        <option value="5">五月</option>
        <option value="6">六月</option>
        <option value="7">七月</option>
        <option value="8">八月</option>
        <option value="9">九月</option>
        <option value="10" selected="">十月</option>
        <option value="11">十一月</option>
        <option value="12">十二月</option>
      </select>
      <select name="storage_date_day"
              required=""
              id="id_storage_date_day"
              style="width: 33.33%;
                     display: inline-block"
              class="selectdatewidget form-control">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7" selected="">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
      </select>
    </fieldset>
  </div>
  <div class="table table-responsive table-container">
    <table class="table table-consumptions cotable-bordered table-striped table-hover table-condensed scroll-vertical ">
      <thead>
        <tr>
          <th class="">{% trans "Ingredient Name" %}</th>
          <th class="">{% trans "Remaining Quantity" %}</th>
          {% for date_h in date_range %}
            <th class="consumption-date">{{ date_h }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for ingredient in ingredients %}
          <tr class="row-consumption"
              data-ingredient_name="{{ ingredient.name }}"
              data-ingredient_quantity="{{ ingredient.quantity }}"
              data-ingredient_total_price="{{ ingredient.total_price }}"
              data-ingredient_meal_type="{{ ingredient.meal_type }}"
              data-ingredient_quantity_unit_name="{{ ingredient.quantity_unit_name }}"
              data-ingredient_unit_price="{{ ingredient.unit_price }}"
              id="ingredient_num_{{ ingredient.id }}">
            <td title="{% blocktrans with storage_date=ingredient.storage_date %}Storaged on {{ storage_date }} .{% endblocktrans %}"
                class="">
              {{ ingredient.name }}
              {% if ingredient.meal_type %}
                <br />
                ({{ ingredient.meal_type }})
              {% endif %}
            </td>
            <td name="remaining_{{ ingredient.id }}">
              {{ ingredient.quantity }}-{{ ingredient.consuming_quantity }}={{ ingredient.remaining_quantity }}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="">
    <button onclick="submit_consumptions();"
            class="btn btn-submit-consumptions btn-primary float-start">
      {% trans "Submit" %}
    </button>
    <button onclick="generate_spreadsheet();"
            class="btn btn-submit-consumptions btn-success float-end">
      {% trans "Generate Spreadsheet" %}
    </button>
    <select class="month-select form-select float-end mx-2" style="width:118px;">
    </select>
  </div>
  <script>
    function get_previous_month_date(date = new Date()) {
  const prevMonthDate = new Date(date);
  prevMonthDate.setDate(1);
  prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
  return prevMonthDate;
}

    function is_weekend(date) {
      const dayOfWeek = date.getDay(); 
      return dayOfWeek === 0 || dayOfWeek === 6; 
    }
    var ingredient_ids = [ 
      {% for ingredient in ingredients %}"{{ingredient.id}}",{% endfor %}
    ];

    $(document).ready(function(){
      var monthes = [...new Set(
        [
        {% for date_h in date_range %}'{{date_h}}',{% endfor %}
      ].map(item => item.slice(0,-3)))]

      $(monthes).each(function(index,value){ 
        $('.month-select').append(`<option>${value}</option>`)
      });
      var now = new Date();
      prev_month = get_previous_month_date(now)
      var year = prev_month.getFullYear();
      var month = prev_month.getMonth()+1 ;
      month = month< 10 ? `0${month}` : `${month}`;
      $('.month-select').val(`${year}-${month}`)

    });

    var ingredient_ids_length = ingredient_ids.length
    
    $(document).ready(function(){
      var last_meal_type=""
      var consumption_rows = $(".row-consumption")
      consumption_rows.each(function(index,element){
        meal_type = $(element).data("ingredient_meal_type")
        if (last_meal_type != meal_type){
          $(element).find("td").css({"color":"red"})
          last_meal_type = meal_type
        }
      });
    });

    $(document).ready(function(){
      var td1 = $(".table tr > :nth-child(1):first")
      $(".table tr > :nth-child(2)").css("left",td1.width())
    });

    $(document).ready(function(){
    $.each(ingredient_ids,function (index, value) {

              $.ajax(
                {
                  url:"/canteen/create_consumption/"+value,
                  method: 'GET',
                  success: function(data){
                    data=$(data)
                    data.each(function(index,element){
                        if (is_weekend(new Date($(element).data("date_of_using")))){
                          $(element).find('[name="amount_used"]').addClass("weekend")
                    }
                    });
                    data.find('input[name="amount_used"]').blur(function(){
                      amount_used = $(this).closest("form").data("amount_used")
                      new_amount_used = $.trim($(this).val())
                      if(parseFloat(amount_used) > 0.0 && new_amount_used === ""){
                        $(this).val('0.0')
                      }
                    });
                    $('#ingredient_num_'+value).append(data)

                  }
                }
              );
    });
    });


    $(document).ready(function() {
    $('.table-consumptions').on('keydown', 'input[name="amount_used"]', function(e) {
        if ([9,13,37,38,39,40].includes(e.keyCode)) {
            e.preventDefault();
            navigateToNextCell(
              $(this), 
              e.keyCode === 9 ? "r" :
              e.keyCode === 13 ? "d" : 
              e.keyCode === 37 ? "l" :
              e.keyCode ===  38 ? "u" :
              e.keyCode === 39 ? "r" :
              e.keyCode === 40 ? "d" : "" 
            );                
        }
      if ((e.keyCode < 91 && e.keyCode > 64) || e.keyCode == 32) {
                e.preventDefault()
                }

    });

   function navigateToNextCell($currentInput,direction ) {
      var td = $currentInput.closest("form").closest('td');
      var columnIndex = td.index();

     var rowIndex = td.closest("tr").index()
     if (direction == 'l'){
       columnIndex = columnIndex - 1
       rowIndex = rowIndex + 1
     }else if(direction == 'r'){
       columnIndex = columnIndex + 1
       rowIndex = rowIndex + 1
     }else if (direction == "u"){
       rowIndex = rowIndex 
     }else if (direction == 'd'){
       rowIndex = rowIndex + 2
     }
      var cell = $('.table-consumptions').find(`tr:eq(${rowIndex}) td:eq(${columnIndex})`);
     var amount_used_input=cell.find('input[name="amount_used"]')
     amount_used_input.first().focus()

   }
    });

    function generate_spreadsheet() {
      submit_consumptions(function (){
        var month = $(".month-select").val()
        window.open(`/canteen/generate_spreadsheet/${month}`, '_blank'); 
      });
       
    }
    function submit_consumptions(fn) {
      consumption_forms =  $('form[name="consumption_form"]')
      var requests = [];
      consumption_forms.each( function(index) {
          var form = $(this);
         if (form.data("is_disabled")=="True"){
           return true;
         }
         if (form.find('input[name="amount_used"]').val().length < 1){
           return true;
         }
        requests.push(
        $.ajax({
        url: form.attr('action'),
        type: form.attr('method') || 'POST', 
        data: form.serialize(),
    }).catch(function(error) {
      return erroe;}));
        });
      $.when.apply($, requests)
  .done(function() {
    if (! fn == undefined){
      fn()
    }
    location.reload();
  })
  .fail(function() {
  });
    }
    function set_consumptions_table_size(){
      const submit_consumptions_btn = $(".btn-submit-consumptions")
      const consumptions_table=$(".table-consumptions")
      const header=$("header")
      const footer=$("footer")
      const height = Math.round((footer.offset().top - submit_consumptions_btn.height() - consumptions_table.offset().top  )*0.95)
        consumptions_table.parent().height(height)
    }
    $(window).resize(function() {
      set_consumptions_table_size()
    });
    $(document).ready(function() {
      set_consumptions_table_size()
});
  </script>
  <style>
body{
}

.weekend {
  background-color:pink;
}

.table-container {
  overflow:auto;
}
  .table thead th {
      position: -webkit-sticky; 
      position: sticky;
      top: 0; 
      z-index: 1010; 
  }

  .table tr {
      font-size:15px;
  }
 .table tr > :nth-child(1) {
      position: -webkit-sticky; 
      position: sticky;
      left: 0;
      z-index: 1010; 
      white-space: nowrap;
  }

  .table tr > :nth-child(2) {
      position: -webkit-sticky; 
      position: sticky;
      z-index: 1010; 
  }
  .table thead tr {
      font-size:15px;
  }
   .table thead tr > :nth-child(1) {
      z-index: 1020;
      white-space: nowrap;
  }
  .table thead tr > :nth-child(2) {
      z-index: 1020; 
  }

nav li {
  z-index: 1030;
}

  </style>
{% endblock %}
