{% extends "base/header_content_footer.html" %}
{% load crispy_forms_tags %}
{% block title %}
  {% trans "Consume Ingredients" %}
{% endblock %}
{% block content %}
  <h1>{% trans "Consume Ingredients" %}</h1>
  <hr>
  <div class="table table-responsive table-container">
    <table class="table table-consumptions cotable-bordered table-striped table-hover table-condensed scroll-vertical ">
      <thead>
        <tr>
          <th class="">{% trans "Ingredient Name" %}</th>
          <th class="">{% trans "Remaining Quantity" %}</th>
          {% for date_h in date_range %}
            <th class="consumption-date">{{ date_h }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for ingredient in ingredients %}
          <tr data-ingredient_name="{{ ingredient.name }}"
              data-ingredient_quantity="{{ ingredient.quantity }}"
              data-ingredient_total_price="{{ ingredient.total_price }}"
              data-ingredient_meal_type="{{ ingredient.meal_type }}"
              data-ingredient_quantity_unit_name="{{ ingredient.quantity_unit_name }}"
              data-ingredient_unit_price="{{ ingredient.unit_price }}"
              id="ingredient_num_{{ ingredient.id }}">
            <td>{{ ingredient.name }}</td>
            <td name="remaining_{{ ingredient.id }}">
              {{ ingredient.quantity }}-{{ ingredient.consuming_quantity }}={{ ingredient.remaining_quantity }}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <button onclick="submit_consumptions();"
          class="btn btn-submit-consumptions btn-primary">
    {% trans "Submit" %}
  </button>
  <script>
    function is_weekend(date) {
      const dayOfWeek = date.getDay(); 
      return dayOfWeek === 0 || dayOfWeek === 6; 
    }
    var ingredient_ids = [ 
      {% for ingredient in ingredients %}"{{ingredient.id}}",{% endfor %}
    ];
    $(document).ready(function(){
    $.each(ingredient_ids,function (index, value) {
              $.ajax(
                {
                  url:"/canteen/create_consumption/"+value,
                  method: 'GET',
                  success: function(data){
                    data=$(data)
                    data.each(function(index,element){
                        if (is_weekend(new Date($(element).data("date_of_using")))){
                          $(element).find('[name="amount_used"]').addClass("weekend")
                    }

                    });
                    $('#ingredient_num_'+value).append(data)
                  }
                }
              );

    });
    });


    $(document).ready(function() {
    $('.table-consumptions').on('keydown', 'input[name="amount_used"]', function(e) {
        if ([9,13,37,38,39,40].includes(e.keyCode)) {
            e.preventDefault();
            navigateToNextCell(
              $(this), 
              e.keyCode === 9 ? "r" :
              e.keyCode === 13 ? "d" : 
              e.keyCode === 37 ? "l" :
              e.keyCode ===  38 ? "u" :
              e.keyCode === 39 ? "r" :
              e.keyCode === 40 ? "d" : "" 
            );                
        }
      if (e.keyCode < 91 && e.keyCode > 64) {
                e.preventDefault()
                }

    });

   function navigateToNextCell($currentInput,direction ) {
      var td = $currentInput.closest("form").closest('td');
      var columnIndex = td.index();

     var rowIndex = td.closest("tr").index()
     if (direction == 'l'){
       columnIndex = columnIndex - 1
       rowIndex = rowIndex + 1
     }else if(direction == 'r'){
       columnIndex = columnIndex + 1
       rowIndex = rowIndex + 1
     }else if (direction == "u"){
       rowIndex = rowIndex 
     }else if (direction == 'd'){
       rowIndex = rowIndex + 2
     }
      var cell = $('.table-consumptions').find(`tr:eq(${rowIndex}) td:eq(${columnIndex})`);
     var amount_used_input=cell.find('input[name="amount_used"]')
     amount_used_input.first().focus()

   }


    });
    function submit_consumptions() {
       $('form[name="consumption_form"]').each(function(index) {
          var form = $(this);
         if (form.data("is_disabled")=="True"){
           return true;
         }
         if (form.find('input[name="amount_used"]').val().length < 1){
           return true;
         }
    $.ajax({
        url: form.attr('action'),
        type: form.attr('method') || 'POST', 
        data: form.serialize(),
        success: function(response) {
            console.log('Form submitted successfully:', response);
        },
        error: function(xhr, status, error) {
            console.error('Form submission failed:', error);
        }
    });
      }); 
    }
    function set_consumptions_table_size(){
      const submit_consumptions_btn = $(".btn-submit-consumptions")
      const consumptions_table=$(".table-consumptions")
      const header=$("header")
      const footer=$("footer")
      const height = Math.round((footer.offset().top - submit_consumptions_btn.height() - consumptions_table.offset().top  )*0.95)
        consumptions_table.parent().height(height)
    }
    $(window).resize(function() {
      set_consumptions_table_size()
    });
    $(document).ready(function() {
      set_consumptions_table_size()
});
  </script>
  <style>
body{
}

.weekend {
  background-color:pink;
}

.table-container {
  overflow:auto;
}
  .table thead th {
      position: -webkit-sticky; 
      position: sticky;
      top: 0; 
      z-index: 1020; 
  }

 .table tr > :nth-child(1) {
      position: -webkit-sticky; 
      position: sticky;
      left: 0; 
      z-index: 1020; 
  }

  .table tr > :nth-child(2) {
      position: -webkit-sticky; 
      position: sticky;
      left: 50px; 
      z-index: 1020; 
  }
   .table thead tr > :nth-child(1) {
      z-index: 1030;
      font-size:15px;
  }
  .table thead tr > :nth-child(2) {
      z-index: 1030; 
      left:50px;
  }

  </style>
{% endblock %}
