{% extends "base/header_content_footer.html" %}
{% load crispy_forms_tags %}
{% block title %}
  {% trans "Consume Ingredients" %}
{% endblock %}
{% block content %}
  <h1>{% trans "Consume Ingredients" %}</h1>
  <hr>
  <div class="table table-responsive table-container">
    <table class="table table-consumptions cotable-bordered table-striped table-hover table-condensed scroll-vertical ">
      <thead>
        <tr>
          <th class="">{% trans "Ingredient Name" %}</th>
          <th class="">{% trans "Remaining Quantity" %}</th>
          {% for date_h in date_range %}<th>{{ date_h }}</th>{% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for ingredient in ingredients %}
          <tr data-ingredient_name="{{ ingredient.name }}"
              data-ingredient_quantity="{{ ingredient.quantity }}"
              data-ingredient_total_price="{{ ingredient.total_price }}"
              data-ingredient_quantity_unit_name="{{ ingredient.quantity_unit_name }}"
              data-ingredient_unit_price="{{ ingredient.unit_price }}"
              id="ingredient_num_{{ ingredient.id }}">
            <td>{{ ingredient.name }}</td>
            <td name="remaining_{{ ingredient.id }}">
              {{ ingredient.quantity }}-{{ ingredient.consuming_quantity }}={{ ingredient.remaining_quantity }}
            </td>
          </tr>
          <script>
            $(function() {
              $.ajax(
                {
                  url:"{% url 'canteen:create_consumption' ingredient.id %}",
                  method: 'GET',
                  success: function(data){
                    $('#ingredient_num_{{ ingredient.id }}').append(data)
                  }
                }
              )
            });

          </script>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <button onclick="submit_consumptions();"
          class="btn btn-submit-consumptions btn-primary">
    {% trans "Submit" %}
  </button>
  <script>
    function submit_consumptions() {
       $('form[name="consumption_form"]').each(function(index) {
          var form = $(this);
         if (form.data("is_disabled")=="True"){
           return true;
         }
         if (form.find('input[name="amount_used"]').val().length < 1){
           return true;
         }
    $.ajax({
        url: form.attr('action'),
        type: form.attr('method') || 'POST', 
        data: form.serialize(),
        success: function(response) {
            console.log('Form submitted successfully:', response);
        },
        error: function(xhr, status, error) {
            console.error('Form submission failed:', error);
        }
    });
      }); 
    }
    function set_consumptions_table_size(){
      const submit_consumptions_btn = $(".btn-submit-consumptions")
      const consumptions_table=$(".table-consumptions")
      const header=$("header")
      const footer=$("footer")
      const height = Math.round((footer.offset().top - submit_consumptions_btn.height() - consumptions_table.offset().top  )*0.95)
        consumptions_table.parent().height(height)
    }
    $(window).resize(function() {
      set_consumptions_table_size()
    });
    $(document).ready(function() {
      set_consumptions_table_size()
});
  </script>
  <style>
body{
}
.table-container {
  overflow:auto;
}
  .table thead th {
      position: -webkit-sticky; 
      position: sticky;
      top: 0; 
      z-index: 1020; 
  }

 .table tr > :nth-child(1) {
      position: -webkit-sticky; 
      position: sticky;
      left: 0; 
      z-index: 1020; 
  }

  .table tr > :nth-child(2) {
      position: -webkit-sticky; 
      position: sticky;
      left: 50px; 
      z-index: 1020; 
  }
   .table thead tr > :nth-child(1) {
      z-index: 1030;
      font-size:15px;
  }
  .table thead tr > :nth-child(2) {
      z-index: 1030; 
      left:50px;
  }

  </style>
{% endblock %}
